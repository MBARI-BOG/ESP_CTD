---
title: "ESP_CTD_control_composition"
author: "Markus Min"
date: "7/29/2021"
output: html_document
---


#### Description
In this Rmd we will prepare and export a table with the composition of the various negative controls for this project.

All of the CSVs exported in this Rmd are combined into one Excel file, TableS4.xlsx.

#### Load libraries
```{r load_libraries}
library(phyloseq)
library(qiime2R)
library(here)
library(vegan)
library(tidyverse)
library(ggpubr)

fig_dir <- here::here("figures", "supplemental")
```

### Load data
Make sure to remove leading Xs from column names in OTU tables
```{r}
#### COI
asv_table_path_COI <- here::here("data", "COI", "ESP_CTD_COI_asv_table.csv")
tax_table_path_COI <- here::here("data", "COI", "ESP_CTD_COI_tax_table.csv")
metadata_path_COI <- here::here("data", "COI", "ESP_CTD_COI_metadata.csv")

# Remove leading Xs
COI_otu_table <- read.csv(asv_table_path_COI, row.names = 1)
names(COI_otu_table) <- sub("X", "", names(COI_otu_table))

ESP_CTD_COI_phyloseq <- merge_phyloseq(otu_table(COI_otu_table,taxa_are_rows = TRUE),
                                       tax_table(as.matrix(read.csv(tax_table_path_COI, row.names = 1))),
                                       sample_data(read.csv(metadata_path_COI, row.names = 1)))
sample_names(ESP_CTD_COI_phyloseq)
setdiff(colnames(read.csv(asv_table_path_COI, row.names = 1)), rownames(read.csv(metadata_path_COI, row.names = 1)))

#### 18S
asv_table_path_18S <- here::here("data", "18S", "ESP_CTD_18S_asv_table.csv")
tax_table_path_18S <- here::here("data", "18S", "ESP_CTD_18S_tax_table.csv")
metadata_path_18S <- here::here("data", "18S", "ESP_CTD_18S_metadata.csv")

# Remove leading Xs
otu_table_18S <- read.csv(asv_table_path_18S, row.names = 1)
names(otu_table_18S) <- sub("X", "", names(otu_table_18S))

ESP_CTD_18S_phyloseq <- merge_phyloseq(otu_table(otu_table_18S,taxa_are_rows = TRUE),
                                       tax_table(as.matrix(read.csv(tax_table_path_18S, row.names = 1))),
                                       sample_data(read.csv(metadata_path_18S, row.names = 1)))

#### 12S
asv_table_path_12S <- here::here("data", "12S", "ESP_CTD_12S_asv_table.csv")
tax_table_path_12S <- here::here("data", "12S", "ESP_CTD_12S_tax_table.csv")
metadata_path_12S <- here::here("data", "12S", "ESP_CTD_12S_metadata.csv")

# Remove leading Xs
otu_table_12S <- read.csv(asv_table_path_12S, row.names = 1)
names(otu_table_12S) <- sub("X", "", names(otu_table_12S))

ESP_CTD_12S_phyloseq <- merge_phyloseq(otu_table(otu_table_12S,taxa_are_rows = TRUE),
                                       tax_table(as.matrix(read.csv(tax_table_path_12S, row.names = 1))),
                                       sample_data(read.csv(metadata_path_12S, row.names = 1)))

### 16S
# Read in combined taxonomy + ASV table
asv_tax_combined_path_16S <- here::here("data", "16S", "ESP_CTD_16S_dada2_table_with_tax.csv")
asv_tax_combined_16S <- read.csv(asv_tax_combined_path_16S)
# Split off asv table
dplyr::select(asv_tax_combined_16S, -Taxon) %>% 
  column_to_rownames("FeatureID") -> asv_table_16S

# Remove leading Xs
names(asv_table_16S) <- sub("X", "", names(asv_table_16S))

# Split off taxonomy, separate into fields per rank
tax_table_16S <- dplyr::select(asv_tax_combined_16S, FeatureID, Taxon)
tax_table_16S$Taxon <- gsub("[a-zA-Z]__","", tax_table_16S$Taxon)
tax_table_16S %>% separate(., Taxon, into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = ";") %>% 
  column_to_rownames("FeatureID") -> tax_table_16S
  
metadata_path_16S <- here::here("data", "16S", "ESP_CTD_16S_metadata.csv")

ESP_CTD_16S_phyloseq <- merge_phyloseq(otu_table(asv_table_16S,taxa_are_rows = TRUE),
                                       tax_table(as.matrix(tax_table_16S)),
                                       sample_data(read.csv(metadata_path_16S, row.names = 1)))
```

## Prepare metadata for controls


```{r prepare_control_metadata}
################# COI
as.data.frame(as.matrix(sample_data(ESP_CTD_COI_phyloseq))) %>% 
  rownames_to_column(., "sample_name") %>% 
  subset(., sample_type.x %in%  c("negative", "blank")) %>% 
  # Add column to describe blank type
  mutate(blank_type = ifelse(grepl("CB", sample_name), "CTD collection blank", 
                             ifelse(grepl("EB", sample_name), "DNA extraction blank", 
                                    ifelse(grepl("post", sample_name), "Control for ESP post-blanks", 
                                           ifelse(grepl("pre", sample_name), "Control for ESP pre-blanks", 
                                                  ifelse(original_name %in% c("CN18FESPkoa_SC1", "CN18S_koa3G_SC29",
                                                                              "CN18S_koa3G_SC30", "CN18S_koa3G_SC31"
                                                                              ), "ESP Pre-experiment blank",
                                                         ifelse(original_name %in% c("CN18FESPkoa_SC59", "CN18S_koa3G_SC57",
                                                                              "CN18S_koa3G_SC58", "CN18S_koa3G_SC59"
                                                                              ), "ESP Post-experiment blank",
                                                                ifelse(grepl("pcr", sample_name), "PCR blank", "other")))))))) %>% 
  # only keep the relevant columns
  dplyr::select(sample_name, SAMPLING_cruise, library, libraryID, locus, original_name, blank_type) %>% 
  dplyr::rename(COI_plate_name = sample_name) ->  blanks_metadata_COI

# Join other plate metadata

################# 18S

# Make one DF for just joining sample names, for those samples that were sequenced for both markers
as.data.frame(as.matrix(sample_data(ESP_CTD_18S_phyloseq))) %>% 
  rownames_to_column(., "sample_name") %>% 
subset(., sample_type.x %in%  c("negative", "blank")) %>% 
  dplyr::rename(`18S_plate_name` = sample_name) %>% 
  dplyr::select(c("18S_plate_name", original_name)) -> sample_names_18S

# Make another DF with complete metadata (for those samples not sequenced by both markers)
as.data.frame(as.matrix(sample_data(ESP_CTD_18S_phyloseq))) %>% 
  rownames_to_column(., "sample_name") %>% 
  subset(., sample_type.x %in%  c("negative", "blank")) %>% 
  # Add column to describe blank type
  mutate(blank_type = ifelse(grepl("CB", sample_name), "CTD collection blank", 
                             ifelse(grepl("EB", sample_name), "DNA extraction blank", 
                                    ifelse(grepl("post", sample_name), "Control for ESP post-blanks", 
                                           ifelse(grepl("pre", sample_name), "Control for ESP pre-blanks", 
                                                  ifelse(original_name %in% c("CN18FESPkoa_SC1", "CN18S_koa3G_SC29",
                                                                              "CN18S_koa3G_SC30", "CN18S_koa3G_SC31"
                                                                              ), "ESP Pre-experiment blank",
                                                         ifelse(original_name %in% c("CN18FESPkoa_SC59", "CN18S_koa3G_SC57",
                                                                              "CN18S_koa3G_SC58", "CN18S_koa3G_SC59"
                                                                              ), "ESP Post-experiment blank",
                                                                ifelse(grepl("pcr", sample_name), "PCR blank", "other")))))))) %>% 
  # only keep the relevant columns
  dplyr::select(sample_name, SAMPLING_cruise, library, libraryID, locus, original_name, blank_type) %>% 
  dplyr::rename(`18S_plate_name` = sample_name) ->  blanks_metadata_18S


################# 12S

# Make one DF for just joining sample names, for those samples that were sequenced for both markers
as.data.frame(as.matrix(sample_data(ESP_CTD_12S_phyloseq))) %>% 
  rownames_to_column(., "sample_name") %>% 
subset(., sample_type.x %in%  c("negative", "blank")) %>% 
  dplyr::rename(`12S_plate_name` = sample_name) %>% 
  dplyr::select(c("12S_plate_name", original_name)) -> sample_names_12S

# Make another DF with complete metadata (for those samples not sequenced by both markers)
as.data.frame(as.matrix(sample_data(ESP_CTD_12S_phyloseq))) %>% 
  rownames_to_column(., "sample_name") %>% 
  subset(., sample_type.x %in%  c("negative", "blank")) %>% 
  # Add column to describe blank type
  mutate(blank_type = ifelse(grepl("CB", sample_name), "CTD collection blank", 
                             ifelse(grepl("EB", sample_name), "DNA extraction blank", 
                                    ifelse(grepl("post", sample_name), "Control for ESP post-blanks", 
                                           ifelse(grepl("pre", sample_name), "Control for ESP pre-blanks", 
                                                  ifelse(original_name %in% c("CN18FESPkoa_SC1", "CN18S_koa3G_SC29",
                                                                              "CN18S_koa3G_SC30", "CN18S_koa3G_SC31"
                                                                              ), "ESP Pre-experiment blank",
                                                         ifelse(original_name %in% c("CN18FESPkoa_SC59", "CN18S_koa3G_SC57",
                                                                              "CN18S_koa3G_SC58", "CN18S_koa3G_SC59"
                                                                              ), "ESP Post-experiment blank",
                                                                ifelse(grepl("pcr", sample_name), "PCR blank", "other")))))))) %>% 
  # only keep the relevant columns
  dplyr::select(sample_name, SAMPLING_cruise, library, libraryID, locus, original_name, blank_type) %>% 
  dplyr::rename(`12S_plate_name` = sample_name) ->  blanks_metadata_12S


################# 16S

# Make one DF for just joining sample names, for those samples that were sequenced for both markers
as.data.frame(as.matrix(sample_data(ESP_CTD_16S_phyloseq))) %>% 
  rownames_to_column(., "sample_name") %>% 
subset(., sample_type !=  "environmental") %>% 
  # change "pst" to "post" 
  mutate(sample_name = gsub("pst", "post", sample_name)) %>% 
  # Fix pre/post blank names so they're consistent
  mutate(sample_name = gsub("CN18FBN1", "CN18FESPkoa_BN1", sample_name)) %>% 
  dplyr::mutate(original_name = sample_name) %>% 
  dplyr::rename(`16S_plate_name` = sample_name) %>% 
  dplyr::select(c("16S_plate_name", original_name)) -> sample_names_16S

# Make another DF with complete metadata (for those samples not sequenced by both markers)
as.data.frame(as.matrix(sample_data(ESP_CTD_16S_phyloseq))) %>% 
  rownames_to_column(., "sample_name") %>% 
subset(., sample_type !=  "environmental") %>% 
  # change "pst" to "post" 
  mutate(sample_name = gsub("pst", "post", sample_name)) %>% 
  # Fix pre/post blank names so they're consistent
mutate(sample_name = gsub("CN18FBN1", "CN18FESPkoa_BN1", sample_name)) %>% 
  dplyr::mutate(original_name = sample_name) %>% 
  # Add column to describe blank type
  mutate(blank_type = ifelse(grepl("CB", sample_name), "CTD collection blank", 
                             ifelse(grepl("EB", sample_name), "DNA extraction blank", 
                                    ifelse(grepl("post", sample_name), "Control for ESP post-blanks", 
                                           ifelse(grepl("pre", sample_name), "Control for ESP pre-blanks", 
                                                  ifelse(original_name %in% c("CN18FESPkoa_SC1", "CN18S_koa3G_SC29",
                                                                              "CN18S_koa3G_SC30", "CN18S_koa3G_SC31"
                                                                              ), "ESP Pre-experiment blank",
                                                         ifelse(original_name %in% c("CN18FESPkoa_SC59", "CN18S_koa3G_SC57",
                                                                              "CN18S_koa3G_SC58", "CN18S_koa3G_SC59"
                                                                              ), "ESP Post-experiment blank",
                                                                ifelse(grepl("pcr", sample_name), "PCR blank", "other")))))))) %>% 
  dplyr::rename(`16S_plate_name` = sample_name) %>% 
  # only keep the relevant columns
  dplyr::select(`16S_plate_name`, SAMPLING_cruise, library, locus, original_name, blank_type) ->  blanks_metadata_16S
```


``` {r join_control_plate_metadata}

# First join all those that have the exact same original name (ignoring PCR blanks, since these are unique for each marker)
blanks_metadata_COI %>% 
  subset(., blank_type != "PCR blank") %>% 
  left_join(., sample_names_18S, by = "original_name") %>% 
  left_join(., sample_names_12S, by = "original_name") %>% 
  left_join(., sample_names_16S, by = "original_name") -> blank_metadata_combined


# bind rows to attach all remaining samples
blank_metadata_combined %>% 
  bind_rows(., subset(blanks_metadata_COI, !(COI_plate_name %in% blank_metadata_combined$COI_plate_name))) %>% 
  bind_rows(., subset(blanks_metadata_18S, !(`18S_plate_name` %in% blank_metadata_combined$`18S_plate_name`))) %>% 
  bind_rows(., subset(blanks_metadata_12S, !(`12S_plate_name` %in% blank_metadata_combined$`12S_plate_name`))) %>% 
  bind_rows(., subset(blanks_metadata_16S, !(`16S_plate_name` %in% blank_metadata_combined$`16S_plate_name`))) -> blank_metadata_combined

# Reorder the columns, remove some
blank_metadata_combined <- blank_metadata_combined[,c("original_name", "blank_type", "COI_plate_name", "18S_plate_name", "12S_plate_name", "16S_plate_name", "SAMPLING_cruise")]

write.csv(blank_metadata_combined, here::here(fig_dir, "blanks_tables", "ESP_CTD_blanks_metadata.csv"), row.names = FALSE)
```

## Prepare ASV/taxa tables

### COI
```{r COI_blanks_ASV_table}
ESP_CTD_COI_blanks_phyloseq <- subset_samples(ESP_CTD_COI_phyloseq, sample_data(ESP_CTD_COI_phyloseq)$sample_type.x %in% c("negative", "blank"))

ESP_CTD_COI_blanks_phyloseq <- prune_taxa(taxa_sums(ESP_CTD_COI_blanks_phyloseq) > 0, ESP_CTD_COI_blanks_phyloseq)

ESP_CTD_COI_blanks_asv_table <- as.data.frame(as.matrix(otu_table(ESP_CTD_COI_blanks_phyloseq)))

# Remove the plate suffix from the sample names
# colnames(ESP_CTD_COI_blanks_asv_table) <- sub("_[^_]+$", "", colnames(ESP_CTD_COI_blanks_asv_table)) 

# Reorder ASVs in order of frequency
ESP_CTD_COI_blanks_asv_table %>% 
  mutate(rowsum = rowSums(.)) %>% 
  arrange(-rowsum) %>% 
  rownames_to_column("ASV") -> ESP_CTD_COI_blanks_asv_table

# Join taxonomy
as.data.frame(as.matrix(tax_table(ESP_CTD_COI_blanks_phyloseq))) %>% 
  rownames_to_column("ASV") -> ESP_CTD_COI_blanks_tax_table

ESP_CTD_COI_blanks_asv_table %>% 
  left_join(., ESP_CTD_COI_blanks_tax_table, by = "ASV") -> ESP_CTD_COI_blanks_asv_tax_table

# Export
write.csv(ESP_CTD_COI_blanks_asv_tax_table, here::here(fig_dir, "blanks_tables", "ESP_CTD_COI_blanks_asv_tax_table.csv"), row.names = FALSE)
```


### 18S
```{r 18S_blanks_ASV_table}
ESP_CTD_18S_blanks_phyloseq <- subset_samples(ESP_CTD_18S_phyloseq, sample_data(ESP_CTD_18S_phyloseq)$sample_type.x %in% c("negative", "blank"))

ESP_CTD_18S_blanks_phyloseq <- prune_taxa(taxa_sums(ESP_CTD_18S_blanks_phyloseq) > 0, ESP_CTD_18S_blanks_phyloseq)

ESP_CTD_18S_blanks_asv_table <- as.data.frame(as.matrix(otu_table(ESP_CTD_18S_blanks_phyloseq)))

# Remove the plate suffix from the sample names
# colnames(ESP_CTD_18S_blanks_asv_table) <- sub("_[^_]+$", "", colnames(ESP_CTD_18S_blanks_asv_table)) 

# Reorder ASVs in order of frequency
ESP_CTD_18S_blanks_asv_table %>% 
  mutate(rowsum = rowSums(.)) %>% 
  arrange(-rowsum) %>% 
  rownames_to_column("ASV") -> ESP_CTD_18S_blanks_asv_table

# Join taxonomy
as.data.frame(as.matrix(tax_table(ESP_CTD_18S_blanks_phyloseq))) %>% 
  rownames_to_column("ASV") -> ESP_CTD_18S_blanks_tax_table

ESP_CTD_18S_blanks_asv_table %>% 
  left_join(., ESP_CTD_18S_blanks_tax_table, by = "ASV") -> ESP_CTD_18S_blanks_asv_tax_table

# Export
write.csv(ESP_CTD_18S_blanks_asv_tax_table, here::here(fig_dir, "blanks_tables", "ESP_CTD_18S_blanks_asv_tax_table.csv"), row.names = FALSE)
```


### 12S
```{r 12S_blanks_ASV_table}
ESP_CTD_12S_blanks_phyloseq <- subset_samples(ESP_CTD_12S_phyloseq, sample_data(ESP_CTD_12S_phyloseq)$sample_type.x %in% c("negative", "blank"))

ESP_CTD_12S_blanks_phyloseq <- prune_taxa(taxa_sums(ESP_CTD_12S_blanks_phyloseq) > 0, ESP_CTD_12S_blanks_phyloseq)

ESP_CTD_12S_blanks_asv_table <- as.data.frame(as.matrix(otu_table(ESP_CTD_12S_blanks_phyloseq)))

# Remove the plate suffix from the sample names
# colnames(ESP_CTD_12S_blanks_asv_table) <- sub("_[^_]+$", "", colnames(ESP_CTD_12S_blanks_asv_table)) 

# Reorder ASVs in order of frequency
ESP_CTD_12S_blanks_asv_table %>% 
  mutate(rowsum = rowSums(.)) %>% 
  arrange(-rowsum) %>% 
  rownames_to_column("ASV") -> ESP_CTD_12S_blanks_asv_table

# Join taxonomy
as.data.frame(as.matrix(tax_table(ESP_CTD_12S_blanks_phyloseq))) %>% 
  rownames_to_column("ASV") -> ESP_CTD_12S_blanks_tax_table

ESP_CTD_12S_blanks_asv_table %>% 
  left_join(., ESP_CTD_12S_blanks_tax_table, by = "ASV") -> ESP_CTD_12S_blanks_asv_tax_table

# Export
write.csv(ESP_CTD_12S_blanks_asv_tax_table, here::here(fig_dir, "blanks_tables", "ESP_CTD_12S_blanks_asv_tax_table.csv"), row.names = FALSE)
```

### 16S
```{r 16S_blanks_ASV_table}
ESP_CTD_16S_blanks_phyloseq <- subset_samples(ESP_CTD_16S_phyloseq, sample_data(ESP_CTD_16S_phyloseq)$sample_type !=  "environmental")

ESP_CTD_16S_blanks_phyloseq <- prune_taxa(taxa_sums(ESP_CTD_16S_blanks_phyloseq) > 0, ESP_CTD_16S_blanks_phyloseq)

ESP_CTD_16S_blanks_asv_table <- as.data.frame(as.matrix(otu_table(ESP_CTD_16S_blanks_phyloseq)))

# Remove the plate suffix from the sample names
# colnames(ESP_CTD_16S_blanks_asv_table) <- sub("_[^_]+$", "", colnames(ESP_CTD_16S_blanks_asv_table)) 

# Reorder ASVs in order of frequency
ESP_CTD_16S_blanks_asv_table %>% 
  mutate(rowsum = rowSums(.)) %>% 
  arrange(-rowsum) %>% 
  rownames_to_column("ASV") -> ESP_CTD_16S_blanks_asv_table

# Join taxonomy
as.data.frame(as.matrix(tax_table(ESP_CTD_16S_blanks_phyloseq))) %>% 
  rownames_to_column("ASV") -> ESP_CTD_16S_blanks_tax_table

ESP_CTD_16S_blanks_asv_table %>% 
  left_join(., ESP_CTD_16S_blanks_tax_table, by = "ASV") -> ESP_CTD_16S_blanks_asv_tax_table

# Export
write.csv(ESP_CTD_16S_blanks_asv_tax_table, here::here(fig_dir, "blanks_tables", "ESP_CTD_16S_blanks_asv_tax_table.csv"), row.names = FALSE)
```












## Summarized figures

```{r set_fig_dir}
fig_dir <- here::here("figures", "supplemental", "blanks_figures")
```



Plot phyla (top 10 + unassigned + other, same as for the direct comparison samples)
phyloseq: ESP_CTD_COI_blanks_phyloseq
metadata: blanks_metadata_COI

## COI


### Make top phyla plot
```{r prep_data}
# Extract ASVs
as.data.frame(otu_table(ESP_CTD_COI_blanks_phyloseq)) %>% 
  rownames_to_column("ASV") -> blanks_COI_ASV_table

# Remove "_X" from the column names
colnames(blanks_COI_ASV_table) <- gsub("_X", "", colnames(blanks_COI_ASV_table))

# Extract taxonomy table
blanks_COI_tax_table <- as.data.frame(as(tax_table(ESP_CTD_COI_blanks_phyloseq),"matrix"))
blanks_COI_tax_table <- tibble::rownames_to_column(blanks_COI_tax_table,"ASV")

# reformat ASV table as long form
blanks_COI_ASV_table %>% 
  pivot_longer(cols = colnames(blanks_COI_ASV_table)[2:ncol(blanks_COI_ASV_table)], names_to = "sample_name") -> blanks_COI_asv_table_long

blanks_COI_asv_table_long %>% 
  left_join(blanks_COI_tax_table, by = "ASV") -> blanks_COI_table

# Add shortened sample names
blanks_metadata_COI %>% 
  mutate(sample_name = COI_plate_name) -> blanks_metadata_COI

# Add more informative sample names
blanks_metadata_COI %>% 
  dplyr::arrange(desc(blank_type)) %>% 
  # add index within each blank_type group
  dplyr::group_by(blank_type) %>% 
  dplyr::mutate(id = dplyr::row_number()) %>% 
  # re-order those that were taken separately for each cruise
  ungroup() %>% 
  group_by(blank_type, SAMPLING_cruise) %>% 
  dplyr::mutate(id = ifelse(blank_type %in% c("ESP Pre-experiment blank", "ESP Post-experiment blank", "Control for ESP pre-blanks", "Control for ESP post-blanks"), dplyr::row_number(), id)) %>% 
  # combine into new name field
  mutate(name = ifelse(blank_type %in% c("DNA extraction blank", "PCR blank"), paste0(blank_type, " ", id),
                       paste0(SAMPLING_cruise, ": ", blank_type, " ", id))) -> blanks_metadata_COI

blanks_COI_table %>% 
  left_join(.,  blanks_metadata_COI, by = "sample_name") -> blanks_COI_table


unique(blanks_COI_table$Phylum)
```

```{r determine_top_phyla}
blanks_COI_table %>% 
  # Change so that "unassigned", "no_hit", and "unknown" will merge together
  mutate(., Phylum = ifelse(Phylum %in% c("unassigned", "no_hit", "unknown"), "Unassigned", Phylum)) %>% 
  group_by(Phylum) %>% 
  summarise(total = sum(value)) -> blanks_COI_phyla_reads

blanks_COI_phyla_reads %>% 
  arrange(., desc(total)) -> blanks_COI_phyla_reads

# Get the top ten phyla; we need top ten, then "unknown" and "other" to get to 12
# Get top 11
top11_phyla <- blanks_COI_phyla_reads$Phylum[1:11]

# Mutate data for plotting to get new phyla (top 10 + unassigned + other)
blanks_COI_table %>% 
  mutate(., Phylum = ifelse(Phylum %in% c("unassigned", "no_hit", "unknown"), "Unassigned", Phylum)) %>% 
  mutate(., phylum2 = ifelse(Phylum %in% top11_phyla, Phylum, "Other")) -> blanks_COI_table

# Calculate proportion of total
blanks_COI_table %>% 
  group_by(name) %>% 
  mutate(rel_reads = value/sum(value)*100) -> blanks_COI_table

# Group by phylum and collapse table
blanks_COI_table %>% 
  group_by(name, phylum2) %>% 
  dplyr::summarise(rel_reads = sum(rel_reads)) -> blanks_COI_table_forplot

# Reorder phyla so that unassigned and other are at the bottom
blanks_COI_table_forplot$phylum2 <- factor(blanks_COI_table_forplot$phylum2, levels = c("Arthropoda", "Bacillariophyta", "Chaetognatha", "Chordata", "Cnidaria", "Gastrotricha", "Haptophyta",  "Ochrophyta", "Oomycota", "Picozoa", "Other", "Unassigned"))

# Make color scale
phylum_colors <- c("#a6cee3",
"#1f78b4",
"#b2df8a",
"#33a02c",
'#fb9a99',
"#e31a1c",
"#fdbf6f",
"#ff7f00",
"#cab2d6",
"#6a3d9a",
"#b15928",
"gray50")
# "#ffff99",
# "#b15928")
```



```{r plot_top_phyla_COI}
blanks_COI_top_phyla_plot_rel_reads <- ggplot(blanks_COI_table_forplot, aes(x = name, y = rel_reads, fill = phylum2)) +
  geom_bar(stat = "identity", color = "black", size = 0.3) +
  scale_fill_manual(values = phylum_colors)+
  labs(x = "Sample", y = "Percentage of total reads") +
  scale_y_reverse(expand = c(0,0), labels = c("100", "75", "50", "25", "0")) +
  coord_flip()+
  scale_x_discrete(expand = c(0,0), limits = rev) + 
  guides(fill = guide_legend(title = "Phylum", nrow = 4, byrow = TRUE, title.position = "top")) +
  theme(panel.background = element_rect(fill = "white",size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14),
        # Remove the axis labels (sample names)so that there is only one set of labels in the combined 16S/16S figure
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.ticks.length.y=unit(0, "cm"),
        axis.ticks.length.x = unit(0.1, "cm"),
        # axis.ticks=element_blank(),
        plot.margin = margin(5, 0.25, 0.25, 0.25, "cm"),
        # plot.margin = margin(0.5, 0.25, 0.25, 0.25, "cm"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        # legend.position = "top",
        # legend.margin = margin(-10, 0, 0, -10),
        # legend.justification = c(-1,1),
        legend.position = c(0.2, 1.08),
        legend.title.align = 0.5)
        # axis.line.x.bottom = element_line(color = "black", size = 1),
        # axis.line.y.left = element_line(color = "black", size = 1))

blanks_COI_top_phyla_plot

ggsave(paste0(fig_dir, "/COI_blanks_phyla_plot_rel_reads.png"), blanks_COI_top_phyla_plot_rel_reads, height = 15, width = 6)
```

Second version of plot showing read counts rather than relative read counts
```{r second_version_showing_absolute_reads}
# Group by phylum and collapse table
blanks_COI_table %>% 
  group_by(name, phylum2) %>% 
  summarise(total_reads = sum(value)) -> blanks_COI_table_forplot_2

# Reorder phyla so that unassigned and other are at the bottom
blanks_COI_table_forplot_2$phylum2 <- factor(blanks_COI_table_forplot_2$phylum2, levels = c("Arthropoda", "Bacillariophyta", "Chaetognatha", "Chordata", "Cnidaria", "Gastrotricha", "Haptophyta",  "Ochrophyta", "Oomycota", "Picozoa", "Other", "Unassigned"))


blanks_COI_top_phyla_plot <- ggplot(blanks_COI_table_forplot_2, aes(x = name, y = total_reads, fill = phylum2)) +
  geom_bar(stat = "identity", color = "black", size = 0.3) +
  scale_fill_manual(values = phylum_colors)+
  labs(x = "Sample", y = "Total Reads") +
  # scale_y_reverse(expand = c(0,0), labels = c("100", "75", "50", "25", "0")) +
  coord_flip()+
  scale_x_discrete(expand = c(0,0), limits = rev) + 
  guides(fill = guide_legend(title = "Phylum", nrow = 4, byrow = TRUE, title.position = "top")) +
  theme(panel.background = element_rect(fill = "white",size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14),
        # Remove the axis labels (sample names)so that there is only one set of labels in the combined 16S/16S figure
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.ticks.length.y=unit(0, "cm"),
        axis.ticks.length.x = unit(0.1, "cm"),
        # axis.ticks=element_blank(),
        plot.margin = margin(5, 0.25, 0.25, 0.25, "cm"),
        # plot.margin = margin(0.5, 0.25, 0.25, 0.25, "cm"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        # legend.position = "top",
        # legend.margin = margin(-10, 0, 0, -10),
        # legend.justification = c(-1,1),
        legend.position = c(0.2, 1.08),
        legend.title.align = 0.5)
        # axis.line.x.bottom = element_line(color = "black", size = 1),
        # axis.line.y.left = element_line(color = "black", size = 1))

blanks_COI_top_phyla_plot

ggsave(paste0(fig_dir, "/COI_blanks_phyla_plot_absolute_reads.png"), blanks_COI_top_phyla_plot, height = 15, width = 6)

```




## 18S


### Make top phyla plot
```{r prep_data}
# Extract ASVs
as.data.frame(otu_table(ESP_CTD_18S_blanks_phyloseq)) %>% 
  rownames_to_column("ASV") -> blanks_18S_ASV_table

# Remove "_X" from the column names
colnames(blanks_18S_ASV_table) <- gsub("_X", "", colnames(blanks_18S_ASV_table))

# Extract taxonomy table
blanks_18S_tax_table <- as.data.frame(as(tax_table(ESP_CTD_18S_blanks_phyloseq),"matrix"))
blanks_18S_tax_table <- tibble::rownames_to_column(blanks_18S_tax_table,"ASV")

# reformat ASV table as long form
blanks_18S_ASV_table %>% 
  pivot_longer(cols = colnames(blanks_18S_ASV_table)[2:ncol(blanks_18S_ASV_table)], names_to = "sample_name") -> blanks_18S_asv_table_long

blanks_18S_asv_table_long %>% 
  left_join(blanks_18S_tax_table, by = "ASV") -> blanks_18S_table

# Add shortened sample names
blanks_metadata_18S %>% 
  mutate(sample_name = `18S_plate_name`) -> blanks_metadata_18S

# Add more informative sample names
blanks_metadata_18S %>% 
  dplyr::arrange(desc(blank_type)) %>% 
  # add index within each blank_type group
  dplyr::group_by(blank_type) %>% 
  dplyr::mutate(id = dplyr::row_number()) %>% 
  # re-order those that were taken separately for each cruise
  ungroup() %>% 
  group_by(blank_type, SAMPLING_cruise) %>% 
  dplyr::mutate(id = ifelse(blank_type %in% c("ESP Pre-experiment blank", "ESP Post-experiment blank", "Control for ESP pre-blanks", "Control for ESP post-blanks"), dplyr::row_number(), id)) %>% 
  # combine into new name field
  mutate(name = ifelse(blank_type %in% c("DNA extraction blank", "PCR blank"), paste0(blank_type, " ", id),
                       paste0(SAMPLING_cruise, ": ", blank_type, " ", id))) -> blanks_metadata_18S

blanks_18S_table %>% 
  left_join(.,  blanks_metadata_18S, by = "sample_name") -> blanks_18S_table


unique(blanks_18S_table$Phylum)
```

```{r determine_top_phyla}
blanks_18S_table %>% 
  # Change so that "unassigned", "no_hit", and "unknown" will merge together
  mutate(., Phylum = ifelse(Phylum %in% c("unassigned", "no_hit", "unknown"), "Unassigned", Phylum)) %>% 
  group_by(Phylum) %>% 
  summarise(total = sum(value)) -> blanks_18S_phyla_reads

blanks_18S_phyla_reads %>% 
  arrange(., desc(total)) -> blanks_18S_phyla_reads

# Get the top ten phyla; we need top ten, then "unknown" and "other" to get to 12
# Get top 11
top11_phyla <- blanks_18S_phyla_reads$Phylum[1:11]

# Mutate data for plotting to get new phyla (top 10 + unassigned + other)
blanks_18S_table %>% 
  mutate(., Phylum = ifelse(Phylum %in% c("unassigned", "no_hit", "unknown"), "Unassigned", Phylum)) %>% 
  mutate(., phylum2 = ifelse(Phylum %in% top11_phyla, Phylum, "Other")) -> blanks_18S_table

# Calculate proportion of total
blanks_18S_table %>% 
  group_by(name) %>% 
  mutate(rel_reads = value/sum(value)*100) -> blanks_18S_table

# Group by phylum and collapse table
blanks_18S_table %>% 
  group_by(name, phylum2) %>% 
  dplyr::summarise(rel_reads = sum(rel_reads)) -> blanks_18S_table_forplot

# Reorder phyla so that unassigned and other are at the bottom
blanks_18S_table_forplot$phylum2 <- factor(blanks_18S_table_forplot$phylum2, levels = c("Arthropoda", "Bacillariophyta", "Basidiomycota", "Cercozoa", "Chlorophyta", "Cnidaria", "Dinoflagellata",  "Euglenozoa","Ochrophyta", "Streptophyta", "Other", "Unassigned"))

# Make color scale
phylum_colors <- c("#a6cee3",
                   "#1f78b4",
                   "#b2df8a",
                   "#33a02c",
                   '#fb9a99',
                   "#e31a1c",
                   "#fdbf6f",
                   "#ff7f00",
                   "#cab2d6",
                   "#6a3d9a",
                   "#b15928",
                   "gray50")
# "#ffff99",
# "#b15928")
```



```{r plot_top_phyla_18S}
blanks_18S_top_phyla_plot_rel_reads <- ggplot(blanks_18S_table_forplot, aes(x = name, y = rel_reads, fill = phylum2)) +
  geom_bar(stat = "identity", color = "black", size = 0.3) +
  scale_fill_manual(values = phylum_colors)+
  labs(x = "Sample", y = "Percentage of total reads") +
  scale_y_reverse(expand = c(0,0), labels = c("100", "75", "50", "25", "0")) +
  coord_flip()+
  scale_x_discrete(expand = c(0,0), limits = rev) + 
  guides(fill = guide_legend(title = "Phylum", nrow = 4, byrow = TRUE, title.position = "top")) +
  theme(panel.background = element_rect(fill = "white",size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14),
        # Remove the axis labels (sample names)so that there is only one set of labels in the combined 16S/16S figure
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.ticks.length.y=unit(0, "cm"),
        axis.ticks.length.x = unit(0.1, "cm"),
        # axis.ticks=element_blank(),
        plot.margin = margin(5, 0.25, 0.25, 0.25, "cm"),
        # plot.margin = margin(0.5, 0.25, 0.25, 0.25, "cm"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        # legend.position = "top",
        # legend.margin = margin(-10, 0, 0, -10),
        # legend.justification = c(-1,1),
        legend.position = c(0.2, 1.08),
        legend.title.align = 0.5)
# axis.line.x.bottom = element_line(color = "black", size = 1),
# axis.line.y.left = element_line(color = "black", size = 1))

blanks_18S_top_phyla_plot

ggsave(paste0(fig_dir, "/18S_blanks_phyla_plot_rel_reads.png"), blanks_18S_top_phyla_plot_rel_reads, height = 15, width = 6)
```

Second version of plot showing read counts rather than relative read counts
```{r second_version_showing_absolute_reads}
# Group by phylum and collapse table
blanks_18S_table %>% 
  group_by(name, phylum2) %>% 
  summarise(total_reads = sum(value)) -> blanks_18S_table_forplot_2

# Reorder phyla so that unassigned and other are at the bottom
blanks_18S_table_forplot_2$phylum2 <- factor(blanks_18S_table_forplot_2$phylum2, levels = c("Arthropoda", "Bacillariophyta", "Basidiomycota", "Cercozoa", "Chlorophyta", "Cnidaria", "Dinoflagellata",  "Euglenozoa","Ochrophyta", "Streptophyta", "Other", "Unassigned"))


blanks_18S_top_phyla_plot <- ggplot(blanks_18S_table_forplot_2, aes(x = name, y = total_reads, fill = phylum2)) +
  geom_bar(stat = "identity", color = "black", size = 0.3) +
  scale_fill_manual(values = phylum_colors)+
  labs(x = "Sample", y = "Total Reads") +
  # scale_y_reverse(expand = c(0,0), labels = c("100", "75", "50", "25", "0")) +
  coord_flip()+
  scale_x_discrete(expand = c(0,0), limits = rev) + 
  guides(fill = guide_legend(title = "Phylum", nrow = 4, byrow = TRUE, title.position = "top")) +
  theme(panel.background = element_rect(fill = "white",size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14),
        # Remove the axis labels (sample names)so that there is only one set of labels in the combined 16S/16S figure
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.ticks.length.y=unit(0, "cm"),
        axis.ticks.length.x = unit(0.1, "cm"),
        # axis.ticks=element_blank(),
        plot.margin = margin(5, 0.25, 0.25, 0.25, "cm"),
        # plot.margin = margin(0.5, 0.25, 0.25, 0.25, "cm"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        # legend.position = "top",
        # legend.margin = margin(-10, 0, 0, -10),
        # legend.justification = c(-1,1),
        legend.position = c(0.2, 1.08),
        legend.title.align = 0.5)
# axis.line.x.bottom = element_line(color = "black", size = 1),
# axis.line.y.left = element_line(color = "black", size = 1))

blanks_18S_top_phyla_plot

ggsave(paste0(fig_dir, "/18S_blanks_phyla_plot_absolute_reads.png"), blanks_18S_top_phyla_plot, height = 15, width = 6)

```



## 12S


### Make top families plot
```{r prep_data}
# Extract ASVs
as.data.frame(otu_table(ESP_CTD_12S_blanks_phyloseq)) %>% 
  rownames_to_column("ASV") -> blanks_12S_ASV_table

# Remove "_X" from the column names
colnames(blanks_12S_ASV_table) <- gsub("_X", "", colnames(blanks_12S_ASV_table))

# Extract taxonomy table
blanks_12S_tax_table <- as.data.frame(as(tax_table(ESP_CTD_12S_blanks_phyloseq),"matrix"))
blanks_12S_tax_table <- tibble::rownames_to_column(blanks_12S_tax_table,"ASV")

# reformat ASV table as long form
blanks_12S_ASV_table %>% 
  pivot_longer(cols = colnames(blanks_12S_ASV_table)[2:ncol(blanks_12S_ASV_table)], names_to = "sample_name") -> blanks_12S_asv_table_long

blanks_12S_asv_table_long %>% 
  left_join(blanks_12S_tax_table, by = "ASV") -> blanks_12S_table

# Add shortened sample names
blanks_metadata_12S %>% 
  mutate(sample_name = `12S_plate_name`) -> blanks_metadata_12S

# Add more informative sample names
blanks_metadata_12S %>% 
  dplyr::arrange(desc(blank_type)) %>% 
  # add index within each blank_type group
  dplyr::group_by(blank_type) %>% 
  dplyr::mutate(id = dplyr::row_number()) %>% 
  # re-order those that were taken separately for each cruise
  ungroup() %>% 
  # Add in the missing sampling cruise
  mutate(SAMPLING_cruise = ifelse(grepl("CN18F", original_name), "CN18F", SAMPLING_cruise)) %>% 
  group_by(blank_type, SAMPLING_cruise) %>% 
  dplyr::mutate(id = ifelse(blank_type %in% c("ESP Pre-experiment blank", "ESP Post-experiment blank", "Control for ESP pre-blanks", "Control for ESP post-blanks"), dplyr::row_number(), id)) %>% 
  # combine into new name field
  mutate(name = ifelse(blank_type %in% c("DNA extraction blank", "PCR blank"), paste0(blank_type, " ", id),
                       paste0(SAMPLING_cruise, ": ", blank_type, " ", id))) -> blanks_metadata_12S

blanks_12S_table %>% 
  left_join(.,  blanks_metadata_12S, by = "sample_name") -> blanks_12S_table


unique(blanks_12S_table$Phylum)
unique(blanks_12S_table$Family)
```

```{r determine_top_families}
blanks_12S_table %>% 
  # Change so that "unassigned", "no_hit", and "unknown" will merge together
  mutate(., Family = ifelse(Family %in% c("unassigned", "no_hit", "unknown"), "Unassigned", Family)) %>% 
  group_by(Family) %>% 
  summarise(total = sum(value)) -> blanks_12S_families_reads

blanks_12S_families_reads %>% 
  arrange(., desc(total)) -> blanks_12S_families_reads

# Get the top ten families; we need top ten, then "unknown" and "other" to get to 12
# Get top 11
top11_families <- blanks_12S_families_reads$Family[1:11]

# Mutate data for plotting to get new families (top 10 + unassigned + other)
blanks_12S_table %>% 
  mutate(., Family = ifelse(Family %in% c("unassigned", "no_hit", "unknown"), "Unassigned", Family)) %>% 
  mutate(., Family2 = ifelse(Family %in% top11_families, Family, "Other")) -> blanks_12S_table

# Calculate proportion of total
blanks_12S_table %>% 
  group_by(name) %>% 
  mutate(rel_reads = value/sum(value)*100) -> blanks_12S_table

# Group by Family and collapse table
blanks_12S_table %>% 
  group_by(name, Family2) %>% 
  dplyr::summarise(rel_reads = sum(rel_reads)) -> blanks_12S_table_forplot

# Reorder families so that unassigned and other are at the bottom
blanks_12S_table_forplot$Family2 <- factor(blanks_12S_table_forplot$Family2, levels = c("Bovidae", "Canidae", "Clupeidae", "Engraulidae",     "Hominidae", "Merlucciidae", "Myctophidae", "Paralichthyidae", "Sebastidae", "Suidae", "Other", "Unassigned"))

# Make color scale
Family_colors <- c("#a6cee3",
                   "#1f78b4",
                   "#b2df8a",
                   "#33a02c",
                   '#fb9a99',
                   "#e31a1c",
                   "#fdbf6f",
                   "#ff7f00",
                   "#cab2d6",
                   "#6a3d9a",
                   "#b15928",
                   "gray50")
# "#ffff99",
# "#b15928")
```



```{r plot_top_families_12S}
blanks_12S_top_families_plot_rel_reads <- ggplot(blanks_12S_table_forplot, aes(x = name, y = rel_reads, fill = Family2)) +
  geom_bar(stat = "identity", color = "black", size = 0.3) +
  scale_fill_manual(values = Family_colors)+
  labs(x = "Sample", y = "Percentage of total reads") +
  scale_y_reverse(expand = c(0,0), labels = c("100", "75", "50", "25", "0")) +
  coord_flip()+
  scale_x_discrete(expand = c(0,0), limits = rev) + 
  guides(fill = guide_legend(title = "Family", nrow = 4, byrow = TRUE, title.position = "top")) +
  theme(panel.background = element_rect(fill = "white",size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14),
        # Remove the axis labels (sample names)so that there is only one set of labels in the combined 16S/16S figure
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.ticks.length.y=unit(0, "cm"),
        axis.ticks.length.x = unit(0.1, "cm"),
        # axis.ticks=element_blank(),
        plot.margin = margin(5, 0.25, 0.25, 0.25, "cm"),
        # plot.margin = margin(0.5, 0.25, 0.25, 0.25, "cm"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        # legend.position = "top",
        # legend.margin = margin(-10, 0, 0, -10),
        # legend.justification = c(-1,1),
        legend.position = c(0.2, 1.08),
        legend.title.align = 0.5)
# axis.line.x.bottom = element_line(color = "black", size = 1),
# axis.line.y.left = element_line(color = "black", size = 1))

blanks_12S_top_families_plot_rel_reads

ggsave(paste0(fig_dir, "/12S_blanks_families_plot_rel_reads.png"), blanks_12S_top_families_plot_rel_reads, height = 15, width = 6)
```

Second version of plot showing read counts rather than relative read counts
```{r second_version_showing_absolute_reads}
# Group by Family and collapse table
blanks_12S_table %>% 
  group_by(name, Family2) %>% 
  summarise(total_reads = sum(value)) -> blanks_12S_table_forplot_2

# Reorder families so that unassigned and other are at the bottom
blanks_12S_table_forplot_2$Family2 <- factor(blanks_12S_table_forplot_2$Family2, levels = c("Bovidae", "Canidae", "Clupeidae", "Engraulidae",     "Hominidae", "Merlucciidae", "Myctophidae", "Paralichthyidae", "Sebastidae", "Suidae", "Other", "Unassigned"))


blanks_12S_top_families_plot <- ggplot(blanks_12S_table_forplot_2, aes(x = name, y = total_reads, fill = Family2)) +
  geom_bar(stat = "identity", color = "black", size = 0.3) +
  scale_fill_manual(values = Family_colors)+
  labs(x = "Sample", y = "Total Reads") +
  # scale_y_reverse(expand = c(0,0), labels = c("100", "75", "50", "25", "0")) +
  coord_flip()+
  scale_x_discrete(expand = c(0,0), limits = rev) + 
  guides(fill = guide_legend(title = "Family", nrow = 4, byrow = TRUE, title.position = "top")) +
  theme(panel.background = element_rect(fill = "white",size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14),
        # Remove the axis labels (sample names)so that there is only one set of labels in the combined 16S/16S figure
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.ticks.length.y=unit(0, "cm"),
        axis.ticks.length.x = unit(0.1, "cm"),
        # axis.ticks=element_blank(),
        plot.margin = margin(5, 0.25, 0.25, 0.25, "cm"),
        # plot.margin = margin(0.5, 0.25, 0.25, 0.25, "cm"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        # legend.position = "top",
        # legend.margin = margin(-10, 0, 0, -10),
        # legend.justification = c(-1,1),
        legend.position = c(0.2, 1.08),
        legend.title.align = 0.5)
# axis.line.x.bottom = element_line(color = "black", size = 1),
# axis.line.y.left = element_line(color = "black", size = 1))

blanks_12S_top_families_plot

ggsave(paste0(fig_dir, "/12S_blanks_families_plot_absolute_reads.png"), blanks_12S_top_families_plot, height = 15, width = 6)

```




## 16S


### Make top phyla plot
```{r prep_data}
# Extract ASVs
as.data.frame(otu_table(ESP_CTD_16S_blanks_phyloseq)) %>% 
  rownames_to_column("ASV") -> blanks_16S_ASV_table

# Remove "_X" from the column names
colnames(blanks_16S_ASV_table) <- gsub("_X", "", colnames(blanks_16S_ASV_table))

# Extract taxonomy table
blanks_16S_tax_table <- as.data.frame(as(tax_table(ESP_CTD_16S_blanks_phyloseq),"matrix"))
blanks_16S_tax_table <- tibble::rownames_to_column(blanks_16S_tax_table,"ASV")

# reformat ASV table as long form
blanks_16S_ASV_table %>% 
  pivot_longer(cols = colnames(blanks_16S_ASV_table)[2:ncol(blanks_16S_ASV_table)], names_to = "sample_name") -> blanks_16S_asv_table_long

blanks_16S_asv_table_long %>% 
  left_join(blanks_16S_tax_table, by = "ASV") -> blanks_16S_table

# Add shortened sample names
blanks_metadata_16S %>% 
  mutate(sample_name = `16S_plate_name`) -> blanks_metadata_16S

# Add more informative sample names
blanks_metadata_16S %>% 
  dplyr::arrange(desc(blank_type)) %>% 
  # add index within each blank_type group
  dplyr::group_by(blank_type) %>% 
  dplyr::mutate(id = dplyr::row_number()) %>% 
  # re-order those that were taken separately for each cruise
  ungroup() %>% 
  group_by(blank_type, SAMPLING_cruise) %>% 
  dplyr::mutate(id = ifelse(blank_type %in% c("ESP Pre-experiment blank", "ESP Post-experiment blank", "Control for ESP pre-blanks", "Control for ESP post-blanks"), dplyr::row_number(), id)) %>% 
  # combine into new name field
  mutate(name = ifelse(blank_type %in% c("DNA extraction blank", "PCR blank"), paste0(blank_type, " ", id),
                       paste0(SAMPLING_cruise, ": ", blank_type, " ", id))) %>% 
  # Fix four sample names to make merging work
  mutate(sample_name = ifelse(sample_name == "CN18FBN2post", "CN18FBN2pst",
                              ifelse(sample_name == "CN18FBN3post", "CN18FBN3pst",
                                     ifelse(sample_name == "CN18FESPkoa_BN1post", "CN18FBN1pst",
                                            ifelse(sample_name == "CN18FESPkoa_BN1pre", "CN18FBN1pre", sample_name)))))-> blanks_metadata_16S

blanks_16S_table %>% 
  left_join(.,  blanks_metadata_16S, by = "sample_name") -> blanks_16S_table


unique(blanks_16S_table$Phylum)
```

```{r determine_top_phyla}
blanks_16S_table %>% 
  # Change so that "unassigned", "no_hit", and "unknown" will merge together
  mutate(Phylum = gsub(" ", "", Phylum)) %>% 
  mutate(., Phylum = ifelse(Phylum %in% c("unassigned", "no_hit", "unknown", ""), "Unassigned", Phylum)) %>% 
  group_by(Phylum) %>% 
  summarise(total = sum(value)) -> blanks_16S_phyla_reads

blanks_16S_phyla_reads %>% 
  arrange(., desc(total)) -> blanks_16S_phyla_reads

# Get the top ten phyla; we need top ten, then "unknown" and "other" to get to 12
# Get top 10
top11_phyla <- blanks_16S_phyla_reads$Phylum[1:11]

# Mutate data for plotting to get new phyla (top 10 + unassigned + other)
blanks_16S_table %>% 
  mutate(Phylum = gsub(" ", "", Phylum)) %>% 
  mutate(., Phylum = ifelse(Phylum %in% c(""), "Unassigned", Phylum)) %>% 
  mutate(., Phylum = ifelse(Phylum %in% c("unassigned", "no_hit", "unknown"), "Unassigned", Phylum)) %>% 
  mutate(., phylum2 = ifelse(Phylum %in% top11_phyla, Phylum, "Other")) -> blanks_16S_table

# Calculate proportion of total
blanks_16S_table %>% 
  group_by(name) %>% 
  mutate(rel_reads = value/sum(value)*100) -> blanks_16S_table

# Group by phylum and collapse table
blanks_16S_table %>% 
  group_by(name, phylum2) %>% 
  dplyr::summarise(rel_reads = sum(rel_reads)) -> blanks_16S_table_forplot

# Reorder phyla so that unassigned and other are at the bottom
blanks_16S_table_forplot$phylum2 <- factor(blanks_16S_table_forplot$phylum2, levels = c("Actinobacteriota", "Bacteroidota",  "Bdellovibrionota",  "Cyanobacteria", "Deinococcota", "Firmicutes", "Patescibacteria", "Planctomycetota", "Proteobacteria",  "Verrucomicrobiota", "Other", "Unassigned"))

# Make color scale
phylum_colors <- c("#a6cee3",
                   "#1f78b4",
                   "#b2df8a",
                   "#33a02c",
                   '#fb9a99',
                   "#e31a1c",
                   "#fdbf6f",
                   "#ff7f00",
                   "#cab2d6",
                   "#6a3d9a",
                   "#b15928",
                   "gray50")
# "#ffff99",
# "#b15928")
```



```{r plot_top_phyla_16S}
blanks_16S_top_phyla_plot_rel_reads <- ggplot(blanks_16S_table_forplot, aes(x = name, y = rel_reads, fill = phylum2)) +
  geom_bar(stat = "identity", color = "black", size = 0.3) +
  scale_fill_manual(values = phylum_colors)+
  labs(x = "Sample", y = "Percentage of total reads") +
  scale_y_reverse(expand = c(0,0), labels = c("100", "75", "50", "25", "0")) +
  coord_flip()+
  scale_x_discrete(expand = c(0,0), limits = rev) + 
  guides(fill = guide_legend(title = "Phylum", nrow = 4, byrow = TRUE, title.position = "top")) +
  theme(panel.background = element_rect(fill = "white",size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14),
        # Remove the axis labels (sample names)so that there is only one set of labels in the combined 16S/16S figure
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.ticks.length.y=unit(0, "cm"),
        axis.ticks.length.x = unit(0.1, "cm"),
        # axis.ticks=element_blank(),
        plot.margin = margin(5, 0.25, 0.25, 0.25, "cm"),
        # plot.margin = margin(0.5, 0.25, 0.25, 0.25, "cm"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        # legend.position = "top",
        # legend.margin = margin(-10, 0, 0, -10),
        # legend.justification = c(-1,1),
        legend.position = c(0.2, 1.08),
        legend.title.align = 0.5)
# axis.line.x.bottom = element_line(color = "black", size = 1),
# axis.line.y.left = element_line(color = "black", size = 1))

blanks_16S_top_phyla_plot_rel_reads

ggsave(paste0(fig_dir, "/16S_blanks_phyla_plot_rel_reads.png"), blanks_16S_top_phyla_plot_rel_reads, height = 15, width = 6)
```

Second version of plot showing read counts rather than relative read counts
```{r second_version_showing_absolute_reads}
# Group by phylum and collapse table
blanks_16S_table %>% 
  group_by(name, phylum2) %>% 
  summarise(total_reads = sum(value)) -> blanks_16S_table_forplot_2

# Reorder phyla so that unassigned and other are at the bottom
blanks_16S_table_forplot_2$phylum2 <- factor(blanks_16S_table_forplot_2$phylum2, levels = c("Actinobacteriota", "Bacteroidota",  "Bdellovibrionota",  "Cyanobacteria", "Deinococcota", "Firmicutes", "Patescibacteria", "Planctomycetota", "Proteobacteria",  "Verrucomicrobiota", "Other", "Unassigned"))


blanks_16S_top_phyla_plot <- ggplot(blanks_16S_table_forplot_2, aes(x = name, y = total_reads, fill = phylum2)) +
  geom_bar(stat = "identity", color = "black", size = 0.3) +
  scale_fill_manual(values = phylum_colors)+
  labs(x = "Sample", y = "Total Reads") +
  # scale_y_reverse(expand = c(0,0), labels = c("100", "75", "50", "25", "0")) +
  coord_flip()+
  scale_x_discrete(expand = c(0,0), limits = rev) + 
  guides(fill = guide_legend(title = "Phylum", nrow = 4, byrow = TRUE, title.position = "top")) +
  theme(panel.background = element_rect(fill = "white",size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14),
        # Remove the axis labels (sample names)so that there is only one set of labels in the combined 16S/16S figure
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.ticks.length.y=unit(0, "cm"),
        axis.ticks.length.x = unit(0.1, "cm"),
        # axis.ticks=element_blank(),
        plot.margin = margin(5, 0.25, 0.25, 0.25, "cm"),
        # plot.margin = margin(0.5, 0.25, 0.25, 0.25, "cm"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        # legend.position = "top",
        # legend.margin = margin(-10, 0, 0, -10),
        # legend.justification = c(-1,1),
        legend.position = c(0.2, 1.08),
        legend.title.align = 0.5)
# axis.line.x.bottom = element_line(color = "black", size = 1),
# axis.line.y.left = element_line(color = "black", size = 1))

blanks_16S_top_phyla_plot

ggsave(paste0(fig_dir, "/16S_blanks_phyla_plot_absolute_reads.png"), blanks_16S_top_phyla_plot, height = 15, width = 6)

```


# Export composite phyla plots for manuscript
```{r export_final_phyla_plots}

fig_dir <- here("figures", "final_figures")

control_abs_reads_comb_plot <- ggarrange(blanks_16S_top_phyla_plot, blanks_18S_top_phyla_plot, blanks_COI_top_phyla_plot, blanks_12S_top_families_plot, heights = 15, widths = 6, nrow = 1, labels = c("(a) 16S", "(b) 18S", "(c) COI", "(d) 12S"),
                                   label.x = 0.01, label.y = 1, font.label = list(size = 24, face = "plain"), hjust = 0)

ggsave(here(fig_dir, "FigS2-control_taxa_abs_reads.pdf"), control_abs_reads_comb_plot, height = 15, width = 24)


control_rel_reads_comb_plot <- ggarrange(blanks_16S_top_phyla_plot_rel_reads, blanks_18S_top_phyla_plot_rel_reads, blanks_COI_top_phyla_plot_rel_reads, blanks_12S_top_families_plot_rel_reads, heights = 15, widths = 6, nrow = 1, labels = c("(a) 16S", "(b) 18S", "(c) COI", "(d) 12S"),
                                   label.x = 0.01, label.y = 1, font.label = list(size = 24, face = "plain"), hjust = 0)

ggsave(here(fig_dir, "FigS3-control_taxa_rel_reads.pdf"), control_rel_reads_comb_plot, height = 15, width = 24)

```






